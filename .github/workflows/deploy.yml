name: Deploy to Aliyun Server

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° v4.0-agentic-architecture åˆ†æ”¯æ—¶
on:
  push:
    branches:
      - v4.0-agentic-architecture
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® SSH å¯†é’¥
      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      # 3. æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
      - name: ğŸ“ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
      
      # 4. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: ğŸš€ Deploy to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          echo "ğŸ”„ Connecting to server..."
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æœ€æ–°ä»£ç å¹¶é‡æ–°éƒ¨ç½²
          ssh $SERVER_USER@$SERVER_IP << 'ENDSSH'
            set -e
            
            echo "ğŸ“‚ Navigating to project directory..."
            cd ${{ secrets.SERVER_PATH }}
            
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            echo "ğŸ›‘ Stopping old containers..."
            docker compose down
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker system prune -f
            
            echo "ğŸ—ï¸ Building and starting containers..."
            docker compose up -d --build
            
            echo "â³ Waiting for services to start..."
            sleep 15
            
            echo "âœ… Deployment completed!"
            echo ""
            echo "ğŸ“Š Container status:"
            docker compose ps
            
            echo ""
            echo "ğŸ“ Recent logs:"
            docker compose logs --tail=20
          ENDSSH
          
          echo "ğŸ‰ Deployment successful!"
      
      # 5. å‘é€éƒ¨ç½²é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to ${{ secrets.SERVER_IP }} succeeded!"
          else
            echo "âŒ Deployment to ${{ secrets.SERVER_IP }} failed!"
          fi
