# 数据库架构技术参考文档

> 本文档供其他项目参考，介绍本项目的数据库搭建方式、数据模型设计和数据流。

---

## 一、技术架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (React + Vite)                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                   后端 (Express + Socket.IO)                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Routes    │  │  Services   │  │   Socket Handlers   │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         └────────────────┼─────────────────────┘             │
│                          ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              Prisma ORM (类型安全的数据访问层)            ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│   PostgreSQL 15         │     │      Redis 7            │
│   (持久化存储)           │     │   (缓存/实时状态)        │
│   - 用户数据             │     │   - 游戏初始化数据       │
│   - 房间/会话            │     │   - 推演任务队列         │
│   - 游戏记录             │     │   - 在线状态             │
└─────────────────────────┘     └─────────────────────────┘
```

---

## 二、Docker 容器化部署

### 2.1 docker-compose.yml 配置

```yaml
services:
  # PostgreSQL 主数据库
  postgres:
    image: postgres:15-alpine          # 使用轻量级 Alpine 镜像
    container_name: game-postgres
    environment:
      POSTGRES_USER: game_user         # 数据库用户名
      POSTGRES_PASSWORD: game_password # 数据库密码
      POSTGRES_DB: game_db             # 数据库名
    ports:
      - "5432:5432"                    # 映射到宿主机端口
    volumes:
      - ./data/postgres:/var/lib/postgresql/data  # 数据持久化到本地
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U game_user -d game_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存数据库
  redis:
    image: redis:7-alpine
    container_name: game-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data             # 数据持久化到本地
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
```

### 2.2 设计要点

1. **本地数据卷**：使用 `./data/` 目录存储数据，便于项目迁移和备份
2. **健康检查**：配置 healthcheck 确保服务就绪后再启动应用
3. **Alpine 镜像**：体积小、启动快，适合开发环境

---

## 三、Prisma ORM 集成

### 3.1 数据库连接配置

```typescript
// src/utils/db.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },   // 开发环境记录 SQL
    { level: 'error', emit: 'stdout' },
    { level: 'warn', emit: 'stdout' },
  ],
});

// 开发环境打印 SQL 查询
if (process.env.NODE_ENV === 'development') {
  prisma.$on('query', (e) => {
    console.log('Query:', e.query);
    console.log('Duration:', e.duration + 'ms');
  });
}

// 优雅关闭连接
process.on('beforeExit', async () => {
  await prisma.$disconnect();
});

export default prisma;
```

### 3.2 环境变量配置

```env
# .env
DATABASE_URL="postgresql://game_user:game_password@localhost:5432/game_db"
REDIS_URL="redis://localhost:6379"
JWT_SECRET="your-secret-key"
```

### 3.3 Schema 定义示例

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id          String   @id @default(uuid())
  username    String   @unique
  password    String                        // bcrypt 加密存储
  nickname    String?
  status      String   @default("active")   // active/frozen
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // 关联关系
  createdRooms  Room[]         @relation("Room_Creator")
  roomPlayers   RoomPlayer[]   @relation("RoomPlayer_User")
  
  @@map("users")  // 映射到数据库表名
}

// 房间表
model Room {
  id             String   @id @default(uuid())
  name           String
  creatorId      String
  hostId         String
  maxPlayers     Int
  currentPlayers Int      @default(0)
  status         String   @default("waiting")  // waiting/playing/closed
  
  creator     User         @relation("Room_Creator", fields: [creatorId], references: [id])
  players     RoomPlayer[]
  gameSession GameSession?
  
  @@map("game_rooms")
}
```

---

## 四、数据模型设计

### 4.1 核心实体关系图

```
┌──────────┐     1:N     ┌──────────────┐     1:1     ┌─────────────┐
│   User   │────────────▶│    Room      │────────────▶│ GameSession │
└──────────┘             └──────────────┘             └─────────────┘
     │                         │                            │
     │ 1:N                     │ 1:N                        │ 1:N
     ▼                         ▼                            ▼
┌──────────────┐         ┌──────────────┐           ┌──────────────┐
│ RoomPlayer   │         │  HostConfig  │           │ PlayerAction │
└──────────────┘         └──────────────┘           └──────────────┘
```

### 4.2 表结构说明

| 表名 | 用途 | 关键字段 |
|------|------|----------|
| users | 用户账号 | username, password(加密), status |
| game_rooms | 游戏房间 | name, status, maxPlayers, hostId |
| room_players | 房间成员 | roomId, userId, role, playerIndex |
| host_configurations | 主持人配置 | apiConfig, gameRules, decisionTimeLimit |
| game_sessions | 游戏会话 | currentRound, roundStatus, gameState(JSON) |
| player_actions | 玩家决策 | round, actionText, aiResponse(JSON) |
| trades | 玩家交易 | initiatorId, targetId, resources(JSON) |
| game_saves | 游戏存档 | saveData(JSON), isAutoSave |

---

## 五、数据流示例

### 5.1 用户注册流程

```typescript
// routes/auth.ts
router.post('/register', async (req, res) => {
  const { username, password } = req.body;
  
  // 1. 检查用户是否存在
  const existing = await prisma.user.findUnique({
    where: { username }
  });
  if (existing) throw new Error('用户已存在');
  
  // 2. 密码加密
  const passwordHash = await bcrypt.hash(password, 10);
  
  // 3. 创建用户
  const user = await prisma.user.create({
    data: {
      username,
      password: passwordHash,
      nickname: username,
      status: 'active',
    },
    select: {  // 只返回安全字段
      id: true,
      username: true,
      nickname: true,
      createdAt: true,
    },
  });
  
  // 4. 生成 JWT Token
  const token = jwt.sign({ userId: user.id }, process.env.JWT_SECRET);
  
  res.json({ token, user });
});
```

### 5.2 创建房间流程

```typescript
// routes/rooms.ts
router.post('/create', authenticateToken, async (req, res) => {
  const { name, maxPlayers, password } = req.body;
  const userId = req.userId;
  
  // 1. 创建房间
  const room = await prisma.room.create({
    data: {
      name,
      maxPlayers,
      currentPlayers: 1,
      status: 'waiting',
      creatorId: userId,
      hostId: userId,
      password: password || null,
    },
  });
  
  // 2. 将创建者加入房间
  await prisma.roomPlayer.create({
    data: {
      roomId: room.id,
      userId,
      role: 'host',
      status: 'joined',
      isHuman: true,
    },
  });
  
  res.json({ room });
});
```

### 5.3 提交决策流程

```typescript
// routes/game.ts
router.post('/:sessionId/action', authenticateToken, async (req, res) => {
  const { sessionId } = req.params;
  const { round, actionText } = req.body;
  const userId = req.userId;
  
  // 1. 验证会话状态
  const session = await prisma.gameSession.findUnique({
    where: { id: sessionId },
  });
  if (session.roundStatus !== 'decision') {
    throw new Error('当前不在决策阶段');
  }
  
  // 2. 检查是否已提交
  const existing = await prisma.playerAction.findFirst({
    where: { sessionId, userId, round },
  });
  
  // 3. 创建或更新决策
  if (existing) {
    await prisma.playerAction.update({
      where: { id: existing.id },
      data: { actionText, submittedAt: new Date() },
    });
  } else {
    await prisma.playerAction.create({
      data: {
        sessionId,
        userId,
        round,
        actionText,
        status: 'pending',
      },
    });
  }
  
  // 4. 通过 WebSocket 广播
  io.to(session.roomId).emit('action_submitted', { userId, round });
  
  res.json({ success: true });
});
```

---

## 六、Redis 缓存使用

### 6.1 连接配置

```typescript
// src/utils/redis.ts
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL, {
  retryStrategy: (times) => Math.min(times * 50, 2000),
  maxRetriesPerRequest: 3,
});

export default redis;
```

### 6.2 典型使用场景

```typescript
// 1. 缓存游戏初始化数据（避免重复调用 AI）
const initKey = `game:init:${roomId}`;
await redis.set(initKey, JSON.stringify(initData), 'EX', 86400); // 24小时过期

// 2. 读取缓存
const cached = await redis.get(initKey);
if (cached) {
  return JSON.parse(cached);
}

// 3. 清理缓存（房间关闭时）
await redis.del(initKey);

// 4. 推演任务状态
await redis.set(`inference:status:${sessionId}:${round}`, 'processing');
await redis.set(`inference:result:${sessionId}:${round}`, JSON.stringify(result));
```

---

## 七、数据库迁移流程

### 7.1 开发环境

```bash
# 1. 修改 schema.prisma 后生成客户端
npx prisma generate

# 2. 创建迁移文件并应用
npx prisma migrate dev --name add_new_field

# 3. 查看迁移状态
npx prisma migrate status
```

### 7.2 生产环境

```bash
# 只应用已有迁移，不创建新迁移
npx prisma migrate deploy
```

### 7.3 数据填充 (Seed)

```typescript
// scripts/seed.ts
async function main() {
  // 创建默认管理员
  const passwordHash = await bcrypt.hash('000000', 10);
  await prisma.user.upsert({
    where: { username: 'developer' },
    update: {},
    create: {
      username: 'developer',
      password: passwordHash,
      nickname: '系统管理员',
      status: 'active',
    },
  });
  
  // 创建测试用户...
  // 创建示例房间...
}

main()
  .finally(() => prisma.$disconnect());
```

运行：`npx tsx scripts/seed.ts`

---

## 八、事务处理示例

```typescript
// 关闭房间时的事务操作
await prisma.$transaction([
  // 1. 更新所有玩家状态为离开
  prisma.roomPlayer.updateMany({
    where: { roomId, status: { not: 'left' } },
    data: { status: 'left', leftAt: new Date() },
  }),
  
  // 2. 更新房间状态
  prisma.room.update({
    where: { id: roomId },
    data: { status: 'closed', currentPlayers: 0 },
  }),
  
  // 3. 结束游戏会话
  prisma.gameSession.updateMany({
    where: { roomId },
    data: { status: 'finished' },
  }),
]);
```

---

## 九、查询优化技巧

### 9.1 选择性查询（减少数据传输）

```typescript
// 只查询需要的字段
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: {
    id: true,
    username: true,
    nickname: true,
    // 不查询 password 等敏感字段
  },
});
```

### 9.2 关联查询

```typescript
// 一次查询获取房间及其玩家
const room = await prisma.room.findUnique({
  where: { id: roomId },
  include: {
    players: {
      where: { status: 'joined' },
      include: { user: { select: { nickname: true } } },
    },
    hostConfig: true,
  },
});
```

### 9.3 分页查询

```typescript
const [rooms, total] = await Promise.all([
  prisma.room.findMany({
    where: { status: 'waiting' },
    orderBy: { createdAt: 'desc' },
    skip: (page - 1) * limit,
    take: limit,
  }),
  prisma.room.count({ where: { status: 'waiting' } }),
]);
```

---

## 十、项目结构参考

```
backend/
├── docker-compose.yml      # Docker 服务配置
├── prisma/
│   ├── schema.prisma       # 数据模型定义
│   └── migrations/         # 迁移文件
├── scripts/
│   ├── seed.ts             # 数据填充脚本
│   └── cleanup-database.ts # 清理脚本
├── src/
│   ├── utils/
│   │   ├── db.ts           # Prisma 客户端
│   │   └── redis.ts        # Redis 客户端
│   ├── routes/
│   │   ├── auth.ts         # 认证相关
│   │   ├── rooms.ts        # 房间管理
│   │   └── game.ts         # 游戏逻辑
│   └── server.ts           # 入口文件
└── .env                    # 环境变量
```

---

## 十一、快速启动命令

```bash
# 1. 启动数据库
cd backend
docker compose up -d

# 2. 安装依赖
npm install

# 3. 生成 Prisma Client
npx prisma generate

# 4. 执行迁移
npx prisma migrate dev

# 5. 填充测试数据
npm run seed

# 6. 启动开发服务器
npm run dev

# 可视化数据库管理
npx prisma studio
```
